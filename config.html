<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>GSV-6CPU | ME-Me&szlig;systeme GmbH</title>

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/bootstrap-slider.css" rel="stylesheet">
    <link href="css/me_messsysteme.css" rel="stylesheet">
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="js/jquery.min.1.11.3.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/bootstrap.min.js"></script>
    <script src="js/bootstrap-slider.js"></script>
    <script src="js/autobahn.min.js"></script>
    <script src="js/smoothie.js"></script>
    <script>

        // the WAMP session we'll be using
        //
        var session = null;
        var option1_last = "";
        var typingTimer = new Array();
        var modul_config = new Array();
        var modul_config_element_count_for_complete_load = 13;
        var setFunctionsByID = {
            'ReadAoutScale1': 'WriteAoutScale1',
            'ReadAoutScale2': 'WriteAoutScale2',
            'ReadAoutScale3': 'WriteAoutScale3',
            'ReadAoutScale4': 'WriteAoutScale4',
            'ReadAoutScale5': 'WriteAoutScale5',
            'ReadAoutScale6': 'WriteAoutScale6'
        };
        var doneTypingInterval = 250;
        var slider_active_channels = null;

        var debug_div = null;

        Object.extend = function (destination, source) {
            for (var property in source) {
                if (source.hasOwnProperty(property)) {
                    destination[property] = source[property];
                }
            }
            return destination;
        }

        function check_isConfig_complete(args) {
            //console.log(args);
            //Array.prototype.push.apply(modul_config, args);
            //modul_config = $.extend({}, modul_config, args);
            //$.merge(modul_config,args);

            modul_config = Object.extend(modul_config, args);
            if (Object.keys(modul_config).length >= modul_config_element_count_for_complete_load) {
                // hide loading modal
                doneLoading();
            }
        }

        function setInputSuccess(inputName) {
            $('#' + inputName).removeClass("has-success has-warning has-error");
            $('#' + inputName + '_glyphicon').removeClass("glyphicon-ok glyphicon-warning-sign glyphicon-remove");

            $('#' + inputName).addClass("has-success");
            $('#' + inputName + '_glyphicon').addClass("glyphicon-ok");
        }

        function setInputWarning(inputName) {
            $('#' + inputName).removeClass("has-success has-warning has-error");
            $('#' + inputName + '_glyphicon').removeClass("glyphicon-ok glyphicon-warning-sign glyphicon-remove");

            $('#' + inputName).addClass("has-warning");
            $('#' + inputName + '_glyphicon').addClass("glyphicon-warning-sign");
        }

        function setInputError(inputName) {
            $('#' + inputName).removeClass("has-success has-warning has-error");
            $('#' + inputName + '_glyphicon').removeClass("glyphicon-ok glyphicon-warning-sign glyphicon-remove");

            $('#' + inputName).addClass("has-error");
            $('#' + inputName + '_glyphicon').addClass("glyphicon-remove");
        }

        function onReceiveError(args) {
            //eventCnt += 1;
            debug_div.innerHTML = '<p>' + args[0] + '</p>' + debug_div.innerHTML;
        }

        function onGetReadAoutScale(args) {
            args = args[0];
            console.log(args);
            if (args[0] != 0) {
                //error
                return
            }
            var inputID = 'ReadAoutScale' + args[1];
            $('#' + inputID + '_value').val(parseFloat(args[2]).toFixed(4));
            setInputSuccess(inputID);

            //modul_config['ReadAoutScale'][args[1]] = args[2];
            var data = {};
            data['ReadAoutScale' + args[1]] = parseFloat(args[2]);
            check_isConfig_complete(data);
        }

        function onGetInterface(args) {
            //console.log(args[0]);
            args = args[0];
            var channels = parseInt(args['anzahl_messwert-frame-objekte']) + 1;
            slider_active_channels.setValue(channels);
            var ge_schreibschutz = $('#ge_schreibschutz');
            if (args['genereller_schreibschutz']) {
                ge_schreibschutz.html('genereller Schreibschutz <span class=\"label label-default label-warning\">aktiviert</span>');
            } else {
                ge_schreibschutz.html('genereller Schreibschutz <span class=\"label label-default label-success\">deaktiviert</span>');
            }
            var sp_schreibschutz = $('#sp_schreibschutz');
            if (args['schnittstellen_spezifischer_schreibschutz']) {
                sp_schreibschutz.html('schnittstellen spezifischer Schreibschutz <span class=\"label label-default label-warning\">aktiviert</span>');
            } else {
                sp_schreibschutz.html('schnittstellen spezifischer Schreibschutz <span class=\"label label-default label-success\">deaktiviert</span>');
            }
            var model_name = $('#model_name');
            model_name.html('Model <span class=\"label label-default label-primary\">' + args['geraete_model'] + '</span>');
            var measure_datatype = $('#measure_datatype');
            measure_datatype.html('output-Datentype <span class=\"label label-default label-primary\">' + args['messwertdatentype'] + '</span>');

            // push config data
            check_isConfig_complete(args);
        }

        function WriteAoutScale1() {
            var scale = parseFloat($('#ReadAoutScale1_value').val());
            session.call("de.me_systeme.gsv.WriteAoutScale", [1, scale]);
        }
        function WriteAoutScale2() {
            var scale = parseFloat($('#ReadAoutScale2_value').val());
            session.call("de.me_systeme.gsv.WriteAoutScale", [2, scale]);
        }
        function WriteAoutScale3() {
            var scale = parseFloat($('#ReadAoutScale3_value').val());
            session.call("de.me_systeme.gsv.WriteAoutScale", [3, scale]);
        }
        function WriteAoutScale4() {
            var scale = parseFloat($('#ReadAoutScale4_value').val());
            session.call("de.me_systeme.gsv.WriteAoutScale", [4, scale]);
        }
        function WriteAoutScale5() {
            var scale = parseFloat($('#ReadAoutScale5_value').val());
            session.call("de.me_systeme.gsv.WriteAoutScale", [5, scale]);
        }
        function WriteAoutScale6() {
            var scale = parseFloat($('#ReadAoutScale6_value').val());
            session.call("de.me_systeme.gsv.WriteAoutScale", [6, scale]);
        }

        function onWriteAoutScale(args) {
            args = args[0];
            console.log(args);
            if (args[0] != 0) {
                alert("cant set A out Scale");
                setInputError('ReadAoutScale');
                return
            }
            session.call("de.me_systeme.gsv.getReadAoutScale", [args[1]]);
            //setInputSuccess('ReadAoutScale');
        }

        window.onload = function () {
            $('#myPleaseWait').modal('show');

            /*
             typingTimer['loading'] = setTimeout(function () {
             doneLoading();
             }, 2000);
             */

            $('#worker').hide();

            // the URL of the WAMP Router (e.g. Crossbar.io)
            //
            var wsuri;
            if (document.location.origin == "file://") {
                wsuri = "ws://localhost:8080/ws";
            } else {
                wsuri = "ws://" + document.location.hostname + ":8080/ws";
            }

            // connect to WAMP server
            //
            var connection = new autobahn.Connection({
                url: wsuri,
                realm: 'me_gsv6'
            });

            connection.onopen = function (new_session) {
                console.log("connected to " + wsuri);

                session = new_session;

                session.subscribe("de.me_systeme.gsv.onError", onReceiveError);
                session.subscribe("de.me_systeme.gsv.onGetInterface", onGetInterface);
                session.subscribe("de.me_systeme.gsv.onGetReadAoutScale", onGetReadAoutScale);
                session.subscribe("de.me_systeme.gsv.onWriteAoutScale", onWriteAoutScale);

                debug_div = document.getElementById('debug_out');

                // try to get all cached informations and then get missing informations

                session.call('de.me_systeme.gsv.getErrors').then(function addErrors(res) {
                    var log_section = document.getElementById('debug_out');
                    res.forEach(function (entry) {
                        //console.log(entry);
                        log_section.innerHTML = '<p>' + entry + '</p>' + log_section.innerHTML;
                    });
                }, session.log);
                session.call("de.me_systeme.gsv.getGetIntetface");
                session.call("de.me_systeme.gsv.getReadAoutScale", [1]);
                session.call("de.me_systeme.gsv.getReadAoutScale", [2]);
                session.call("de.me_systeme.gsv.getReadAoutScale", [3]);
                session.call("de.me_systeme.gsv.getReadAoutScale", [4]);
                session.call("de.me_systeme.gsv.getReadAoutScale", [5]);
                session.call("de.me_systeme.gsv.getReadAoutScale", [6]);
            };
            connection.open();

            $("input.modul_settings").keyup(onKeyUpConfigInputs);
            $("input.modul_settings").keydown(onKeyDownConfigInputs);
            slider_active_channels = new Slider("#option_channel_count", {
                ticks: [1, 2, 3, 4, 5, 6],
                ticks_labels: ['1', '2', '3', '4', '5', '6'],
                ticks_snap_bounds: 30
            });
            $('#option_channel_count').on('slideStop', function () {
                console.log("fertig");
            });

        };

        function doneLoading() {
            $('#myPleaseWait').modal('hide');
        }

        function onKeyUpConfigInputs(e) {
            //ESC==27
            //ENTER=13
            if ((e.which == 27) || (e.which == 13)) {
                return;
            }
            var inputID = $(this).data('id');
            /*
             console.log(e.which);
             console.log("keyup");
             */
            clearTimeout(typingTimer);
            typingTimer[inputID] = setTimeout(function () {
                doneTyping(inputID);
            }, doneTypingInterval);
        }

        function onKeyDownConfigInputs(e) {
            var inputID = $(this).data('id');
            clearTimeout(typingTimer[inputID]);

            //ESC==27
            //ENTER=13
            if (e.which == 27) {
                console.log(inputID);
                $('#' + inputID + '_value').val(modul_config[inputID]);
                setInputSuccess(inputID);
            } else if (($('#' + inputID + '_value').val() == '')) {
                setInputError(inputID);
            } else if ((e.which == 13) && (modul_config[inputID] != $('#' + inputID + '_value').val())) {
                // übernehmen
                setInputWarning(inputID);
                window[setFunctionsByID[inputID]]();
            }
        }

        function doneTyping(inputID) {
            if (modul_config[inputID] != $('#' + inputID + '_value').val()) {
                setInputWarning(inputID);
            }
            else {
                setInputSuccess(inputID);
            }
        }

        function test() {
            console.log("test");
            $('#dropdownMenu1')
            $('#option1_glyphicon').hide();
            $('#option1').removeClass("has-success");
        }

        function option1_change() {
            $('#option1').removeClass("has-success has-warning has-error");
            $('#option1_glyphicon').removeClass("glyphicon-ok glyphicon-warning-sign glyphicon-remove");
            if ($('#option1_value').val() != option1_last) {
                $('#option1').addClass("has-warning");
                $('#option1_glyphicon').addClass("glyphicon-warning-sign");
            } else {
                $('#option1').addClass("has-success");
                $('#option1_glyphicon').addClass("glyphicon-ok");
            }
        }
    </script>

</head>
<body>
<nav class="navbar navbar-default">
    <div class="container-fluid">
        <div class="navbar-header">
            <a class="navbar-brand" href="#">ME-Me&szlig;systeme GmbH</a>
        </div>
        <div>
            <ul class="nav navbar-nav">
                <li><a href="index.html">Messung</a></li>
                <li class="active"><a href="#">Konfiguration</a></li>
                <li><a href="#">Messungen</a></li>
                <li><a href="#">Log</a></li>
                <li><a id="worker"><img src="images/ajax-loader_rechteck.gif" alt="loader_gif"></a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container">
    <!-- Modal Start here-->
    <div class="modal fade bs-example-modal-sm" id="myPleaseWait" tabindex="-1"
         role="dialog" aria-hidden="true" data-backdrop="static">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">
                    <span class="glyphicon glyphicon-time">
                    </span> Konfiguration wird geladen...
                    </h4>
                </div>
                <div class="modal-body">
                    <div class="progress">
                        <div class="progress-bar progress-bar-info
                    progress-bar-striped active"
                             style="width: 100%">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal ends Here -->
    <button type="button" class="btn btn-success" onclick="test()">test</button>
    <input type="text" data-id="x" class="testc">

    <div class="well well-sm">Modul Info</div>

    <div class="row">
        <div id="ge_schreibschutz" class="col-sm-4 box">ge Schreibschutz</span></div>
        <div id="sp_schreibschutz" class="col-sm-4 box">sp Schreibschutz</span></div>
        <div id="model_name" class="col-sm-2 box"></div>
        <div id="measure_datatype" class="col-sm-2 box"></div>
        <div class="col-sm-3 box">
            <label for="option1_value">aktive Kan&auml;le:</label>

            <div id="option1" class="form-group has-success has-feedback">
                <input id="option_channel_count" data-slider-id="option_channel_count" class="form-control" type="text"
                       data-slider-ticks="[1, 2, 3, 4, 5, 6]"
                       data-slider-ticks-snap-bounds="1" data-slider-ticks-labels='["1", "2", "3", "4", "5", "6"]'/>
            </div>
        </div>
    </div>
    <div class="well well-sm">Modul Settings</div>
    <div class="panel panel-default">
        <div class="panel-heading">outScale</div>
        <div class="panel-body">
            <div class="row">
                <div class="col-sm-2 box">
                    <div id="ReadAoutScale1" class="form-group has-success has-feedback">
                        <label for="ReadAoutScale1_value">Kanal 1:</label>
                        <input id="ReadAoutScale1_value" data-id="ReadAoutScale1" type="number" step="0.01" min="-400"
                               max="400"
                               class="form-control modul_settings">
                        <span id="ReadAoutScale1_glyphicon" class="glyphicon glyphicon-ok form-control-feedback"></span>
                    </div>
                </div>
                <div class="col-sm-2 box">
                    <div id="ReadAoutScale2" class="form-group has-success has-feedback">
                        <label for="ReadAoutScale2_value">Kanal 2:</label>
                        <input id="ReadAoutScale2_value" data-id="ReadAoutScale2" type="number" step="0.01" min="-400"
                               max="400"
                               class="form-control modul_settings">
                        <span id="ReadAoutScale2_glyphicon" class="glyphicon glyphicon-ok form-control-feedback"></span>
                    </div>
                </div>
                <div class="col-sm-2 box">
                    <div id="ReadAoutScale3" class="form-group has-success has-feedback">
                        <label for="ReadAoutScale3_value">Kanal 3:</label>
                        <input id="ReadAoutScale3_value" data-id="ReadAoutScale3" type="number" step="0.01" min="-400"
                               max="400"
                               class="form-control modul_settings">
                        <span id="ReadAoutScale3_glyphicon" class="glyphicon glyphicon-ok form-control-feedback"></span>
                    </div>
                </div>
                <div class="col-sm-2 box">
                    <div id="ReadAoutScale4" class="form-group has-success has-feedback">
                        <label for="ReadAoutScale4_value">Kanal 4:</label>
                        <input id="ReadAoutScale4_value" data-id="ReadAoutScale4" type="number" step="0.01" min="-400"
                               max="400"
                               class="form-control modul_settings">
                        <span id="ReadAoutScale4_glyphicon" class="glyphicon glyphicon-ok form-control-feedback"></span>
                    </div>
                </div>
                <div class="col-sm-2 box">
                    <div id="ReadAoutScale5" class="form-group has-success has-feedback">
                        <label for="ReadAoutScale5_value">Kanal 5:</label>
                        <input id="ReadAoutScale5_value" data-id="ReadAoutScale5" type="number" step="0.01" min="-400"
                               max="400"
                               class="form-control modul_settings">
                        <span id="ReadAoutScale5_glyphicon" class="glyphicon glyphicon-ok form-control-feedback"></span>
                    </div>
                </div>
                <div class="col-sm-2 box">
                    <div id="ReadAoutScale6" class="form-group has-success has-feedback">
                        <label for="ReadAoutScale6_value">Kanal 6:</label>
                        <input id="ReadAoutScale6_value" data-id="ReadAoutScale6" type="number" step="0.01" min="-400"
                               max="400"
                               class="form-control modul_settings">
                        <span id="ReadAoutScale6_glyphicon" class="glyphicon glyphicon-ok form-control-feedback"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="option1" class="form-group has-success has-feedback">
        <label for="option1_value">Name:</label>
        <input id="option1_value" type="text" class="form-control" onchange="option1_change()">
        <span id="option1_glyphicon" class="glyphicon glyphicon-ok form-control-feedback"></span>
    </div>

    <div class="dropdown">
        <button class="btn btn-default dropdown-toggle btn-success" type="button" id="dropdownMenu1"
                data-toggle="dropdown"
                aria-haspopup="true" aria-expanded="true">
            Dropdown
            <span class="caret"></span>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
            <li><a href="#">Action</a></li>
            <li><a href="#">Another action</a></li>
            <li><a href="#">Something else here</a></li>
            <li><a href="#">Separated link</a></li>
        </ul>
    </div>

    <div class="panel panel-primary">
        <div class="panel-heading">Debug
            <div id="event-cnt" style="float:right;">-</div>
        </div>
        <div id="debug_out" class="panel-body" style="max-height: 200px;overflow-y: scroll;"></div>
    </div>
</div>
</div>
</div>
</body>
</html>